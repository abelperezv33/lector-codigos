<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Lector de Códigos de Barras</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f2f2f2;
    }
    video {
      width: 95vw;
      max-width: 600px;
      margin-top: 1em;
    }
    #output, #photos {
      margin-top: 1em;
      width: 90%;
      max-width: 600px;
    }
    button {
      margin: 0.5em;
      padding: 0.6em 1em;
      font-size: 1em;
    }
    small {
      margin-top: 1em;
      color: gray;
    }
    canvas { display: none; }
    img.preview {
      max-width: 100%;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
  <h2>📦 Escáner de Códigos</h2>
  <video id="video" autoplay></video>

  <div>
    <button onclick="clearList()">🗑️ Borrar lista</button>
    <button onclick="downloadList()">📄 Descargar lista</button>
    <button onclick="takePhoto()" id="photoBtn" disabled>📷 Tomar foto</button>
  </div>

  <div id="output">
    <h3>📋 Lista de Códigos:</h3>
    <ul id="codesList"></ul>
  </div>

  <div id="photos">
    <h3>🖼️ Fotos tomadas:</h3>
    <div id="photoContainer"></div>
  </div>

  <canvas id="canvas"></canvas>

  <small>Programado por Abel Pérez. 2025</small>

  <script>
    const codeReader = new ZXing.BrowserBarcodeReader();
    const video = document.getElementById('video');
    const codes = new Set();
    const listElement = document.getElementById('codesList');
    const photoBtn = document.getElementById('photoBtn');
    let lastCode = '';
    
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    async function startScanner() {
      try {
        const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
        const backCam = devices.find(device => /back|trasera/i.test(device.label)) || devices[0];
        await codeReader.decodeFromVideoDevice(backCam.deviceId, 'video', (result, err) => {
          if (result) {
            const code = result.text.trim();
            if (!codes.has(code)) {
              codes.add(code);
              lastCode = code;
              updateList();
              photoBtn.disabled = false;
            }
          }
        });
      } catch (error) {
        console.error('Error al acceder a la cámara', error);
      }
    }

    function updateList() {
      listElement.innerHTML = '';
      codes.forEach(code => {
        const li = document.createElement('li');
        li.textContent = code;
        listElement.appendChild(li);
      });
    }

    function clearList() {
      codes.clear();
      updateList();
      document.getElementById('photoContainer').innerHTML = '';
      photoBtn.disabled = true;
    }

    function downloadList() {
      const blob = new Blob([Array.from(codes).join('\n')], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'codigos_' + new Date().toISOString().split('T')[0] + '.txt';
      link.click();
    }

    function takePhoto() {
      const videoEl = document.getElementById('video');
      canvas.width = videoEl.videoWidth;
      canvas.height = videoEl.videoHeight;
      ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(blob => {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `${lastCode}_${timestamp}.png`;
        const url = URL.createObjectURL(blob);

        const img = document.createElement('img');
        img.src = url;
        img.className = 'preview';

        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.textContent = `📷 Descargar ${filename}`;
        link.style.display = 'block';

        const container = document.createElement('div');
        container.appendChild(img);
        container.appendChild(link);
        document.getElementById('photoContainer').appendChild(container);
      }, 'image/png');
    }

    startScanner();
  </script>
</body>
</html>
